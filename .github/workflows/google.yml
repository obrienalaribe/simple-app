name: Build and Deploy to GKE

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  GKE_CLUSTER: paid-network-cluster   
  GKE_ZONE: europe-west1 
  DEPLOYMENT_NAME: simple-app
  IMAGE: simple-app
  PROJECT_ID: mv-service-project-7215

jobs:
  build-docker-image:
    name: Build & Publish Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    # Setup gcloud CLI
    - uses: google-github-actions/setup-gcloud@v0.2.0
      with:
        service_account_key: ${{ secrets.GKE_SA_KEY }}
        project_id: mv-service-project-7215

    # Configure Docker to use the gcloud command-line tool as a credential
    # helper for authentication
    - name: Configure GCR
      run: |-
        gcloud --quiet auth configure-docker

    # Build the Docker image
    - name: Build Docker Image
      run: |-
        docker build \
          --tag "gcr.io/mv-service-project-7215/$IMAGE:$GITHUB_SHA" \
          .
    - name: Publish Image to GCR
      run: |-
        docker push "gcr.io/mv-service-project-7215/$IMAGE:$GITHUB_SHA"
      
  generate-k8s-artifacts:
    name: Generate & Kustomize k8s manifests
    runs-on: ubuntu-latest
    needs: build-docker-image
      
    steps:
    - name: Set up Kustomize
      run: |-
        curl -sfLo kustomize https://github.com/kubernetes-sigs/kustomize/releases/download/v3.1.0/kustomize_3.1.0_linux_amd64
        chmod u+x ./kustomize
    
    - name: Create artifacts folder
      run: |-
        mkdir k8s-artifacts
        
    - name: Create k8s manifests
      run: |-
        sed -i -e "s/${IMAGE}:.*/${IMAGE}:${GITHUB_SHA}/g" k8s/base/deployment.yaml
        ./kustomize build ./k8s/overlays/dev/ > ./k8s-artifacts/${IMAGE}-${GITHUB_SHA}.yaml
        cat ./k8s-artifacts/${IMAGE}-${GITHUB_SHA}.yaml

    - name: Save k8s manifest as artifact
      uses: actions/upload-artifact@v2
      with:
        name: manifests
        path: k8s-artifacts
    
  trigger-deployment:
    name: Trigger CD phase
    runs-on: ubuntu-latest
    needs: generate-k8s-artifacts
    
    
    steps:
    - name: Checkout CD repo
      uses: actions/checkout@master
      with:
        repository: obrienalaribe/k8s-manifests
   
    - name: Show folder content
      run: |-
        ls -la 
    
